{% extends "base.html" %}

{% block content %}
    <h1>Select Releases from "{{ folder_name }}" Folder</h1>

    <form method="POST" action="{{ url_for('main.releases', folder_id=folder_id) }}">
        <div style="margin-bottom: 20px;">
            <label for="sort_order">
                Sort by:
                <select id="sort_order" name="sort_order">
                    <option value="artist_az" {% if sort_by == 'artist_az' %}selected{% endif %}>Artist (A-Z)</option>
                    <option value="artist_za" {% if sort_by == 'artist_za' %}selected{% endif %}>Artist (Z-A)</option>
                    <option value="newest_first" {% if sort_by == 'newest_first' %}selected{% endif %}>Newest First</option>
                    <option value="oldest_first" {% if sort_by == 'oldest_first' %}selected{% endif %}>Oldest First</option>
                    <option value="date_added" {% if sort_by == 'date_added' %}selected{% endif %}>Date Added</option>
                </select>
            </label>

            <button type="submit" name="sort_only" value="1" style="margin-left: 10px;">Apply Sorting</button>
        </div>

        <table id="releases-table">
            <thead>
                <tr>
                    <th>Select</th>
                    <th>Title</th>
                    <th>Artist</th>
                    <th>Year</th>
                    <th>Type</th>
                    <th>Date Added</th>
                </tr>
            </thead>
            <tbody>
                {% for release in releases %}
                <tr class="release-row">
                    <td>
                        <input type="checkbox" name="release_ids"
                               value="{{ release.id }}" id="release_{{ release.id }}">
                    </td>
                    <td>{{ release.title }}</td>
                    <td>{{ release.artist }}</td>
                    <td>{{ release.year }}</td>
                    <td>{% if release.format %}{{ release.format[0].name }}{% endif %}</td>
                    <td>{{ release.date_added }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <div style="margin-top: 20px;">
            <button type="button" name="select-all" id="select-all">Select All</button>
            <button type="button" name="deselect-all" id="deselect-all" class="btn-secondary">Deselect All</button>
        </div>

        <div style="margin-top: 15px;">
            <label for="letter-select">Select by Artist Starting Letter:</label>
            <div id="letter-dropdown-container" style="position: relative; display: inline-block;">
                <button type="button" id="letter-dropdown-button" style="padding: 5px 10px; cursor: pointer;">
                    Select Letters (0)
                </button>
                <div id="letter-dropdown-menu" style="
                    display: none;
                    position: absolute;
                    background-color: white;
                    border: 1px solid #ccc;
                    padding: 10px;
                    z-index: 1000;
                    max-height: 300px;
                    overflow-y: auto;
                    width: 250px;
                ">
                    <div style="margin-bottom: 10px;">
                        <input type="text" id="letter-search" placeholder="Search letters..."
                               style="width: 100%; padding: 5px; box-sizing: border-box;">
                    </div>
                    <div id="letter-options" style="display: flex; flex-wrap: wrap; gap: 5px;">
                        <!-- Letter options will be dynamically generated here -->
                    </div>
                    <div style="margin-top: 10px; text-align: right;">
                        <button type="button" id="clear-letter-selection" style="padding: 3px 8px;">Clear</button>
                    </div>
                </div>
            </div>
            <button type="button" id="select-by-letter" style="margin-left: 10px;">Select by Letter</button>
            <button type="button" id="deselect-by-letter" class="btn-secondary">Deselect by Letter</button>
        </div>

        <div class="actions">
            <button type="submit" name="action" value="preview">Preview CSV</button>
            <a href="{{ url_for('main.folders') }}" class="btn-secondary">Back to Folders</a>
        </div>
    </form>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Select All button
            document.getElementById('select-all').addEventListener('click', function() {
                const checkboxes = document.querySelectorAll('input[name="release_ids"]');
                checkboxes.forEach(function(checkbox) {
                    checkbox.checked = true;
                });
            });

            // Deselect All button
            document.getElementById('deselect-all').addEventListener('click', function() {
                const checkboxes = document.querySelectorAll('input[name="release_ids"]');
                checkboxes.forEach(function(checkbox) {
                    checkbox.checked = false;
                });
            });

            // Letter selection functionality
            let selectedLetters = new Set();
            let availableLetters = new Set();
            
            // Function to extract first letter category from artist name
            function getArtistFirstLetterCategory(artistName) {
                if (!artistName) return null;
                
                const firstChar = artistName.charAt(0).toUpperCase();
                
                if (/^[0-9]/.test(firstChar)) {
                    return '0-9';
                } else if (/^[A-Z]/.test(firstChar)) {
                    return firstChar;
                } else {
                    return 'other';
                }
            }
            
            // Function to update available letters based on artists in table
            function updateAvailableLetters() {
                availableLetters.clear();
                
                const artistCells = document.querySelectorAll('#releases-table tbody td:nth-child(3)');
                artistCells.forEach(cell => {
                    const artistName = cell.textContent.trim();
                    const letter = getArtistFirstLetterCategory(artistName);
                    if (letter) {
                        availableLetters.add(letter);
                    }
                });
                
                // Always include 0-9 and other as options
                availableLetters.add('0-9');
                availableLetters.add('other');
            }
            
            // Function to render letter options
            function renderLetterOptions() {
                const letterOptionsContainer = document.getElementById('letter-options');
                letterOptionsContainer.innerHTML = '';
                
                // Sort letters: A-Z first, then 0-9, then other
                const sortedLetters = Array.from(availableLetters).sort((a, b) => {
                    if (a === '0-9') return 1;
                    if (b === '0-9') return -1;
                    if (a === 'other') return 1;
                    if (b === 'other') return -1;
                    return a.localeCompare(b);
                });
                
                sortedLetters.forEach(letter => {
                    const button = document.createElement('button');
                    button.type = 'button';
                    button.textContent = letter;
                    button.style.padding = '5px 10px';
                    button.style.cursor = 'pointer';
                    button.style.border = '1px solid #ccc';
                    button.style.backgroundColor = selectedLetters.has(letter) ? '#007bff' : 'white';
                    button.style.color = selectedLetters.has(letter) ? 'white' : 'black';
                    
                    button.addEventListener('click', function() {
                        if (selectedLetters.has(letter)) {
                            selectedLetters.delete(letter);
                            button.style.backgroundColor = 'white';
                            button.style.color = 'black';
                        } else {
                            selectedLetters.add(letter);
                            button.style.backgroundColor = '#007bff';
                            button.style.color = 'white';
                        }
                        updateDropdownButtonText();
                    });
                    
                    letterOptionsContainer.appendChild(button);
                });
            }
            
            // Function to update dropdown button text
            function updateDropdownButtonText() {
                const button = document.getElementById('letter-dropdown-button');
                if (selectedLetters.size === 0) {
                    button.textContent = 'Select Letters (0)';
                } else if (selectedLetters.size === 1) {
                    button.textContent = `Selected: ${Array.from(selectedLetters)[0]} (1)`;
                } else {
                    button.textContent = `Selected: ${selectedLetters.size} letters`;
                }
            }
            
            // Dropdown toggle functionality
            document.getElementById('letter-dropdown-button').addEventListener('click', function() {
                const dropdownMenu = document.getElementById('letter-dropdown-menu');
                if (dropdownMenu.style.display === 'none' || dropdownMenu.style.display === '') {
                    dropdownMenu.style.display = 'block';
                } else {
                    dropdownMenu.style.display = 'none';
                }
            });
            
            // Close dropdown when clicking outside
            document.addEventListener('click', function(event) {
                const dropdownContainer = document.getElementById('letter-dropdown-container');
                if (!dropdownContainer.contains(event.target)) {
                    document.getElementById('letter-dropdown-menu').style.display = 'none';
                }
            });
            
            // Clear selection button
            document.getElementById('clear-letter-selection').addEventListener('click', function() {
                selectedLetters.clear();
                updateDropdownButtonText();
                renderLetterOptions();
            });
            
            // Search functionality for letters
            document.getElementById('letter-search').addEventListener('input', function(e) {
                const searchTerm = e.target.value.toLowerCase();
                const buttons = document.querySelectorAll('#letter-options button');
                
                buttons.forEach(button => {
                    const letter = button.textContent.toLowerCase();
                    if (letter.includes(searchTerm)) {
                        button.style.display = 'inline-block';
                    } else {
                        button.style.display = 'none';
                    }
                });
            });
            
            // Initialize letter selection
            updateAvailableLetters();
            renderLetterOptions();

            // Select by Letter button
            document.getElementById('select-by-letter').addEventListener('click', function() {
                if (selectedLetters.size === 0) {
                    alert('Please select at least one letter');
                    return;
                }

                const checkboxes = document.querySelectorAll('input[name="release_ids"]');
                checkboxes.forEach(function(checkbox) {
                    const row = checkbox.closest('tr');
                    const artistCell = row.querySelector('td:nth-child(3)'); // Artist is in 3rd column
                    const artistName = artistCell.textContent.trim();
                    
                    // Check if artist starts with any of the selected letters
                    const artistLetter = getArtistFirstLetterCategory(artistName);
                    const shouldSelect = selectedLetters.has(artistLetter);
                    
                    checkbox.checked = shouldSelect;
                });
            });

            // Deselect by Letter button
            document.getElementById('deselect-by-letter').addEventListener('click', function() {
                if (selectedLetters.size === 0) {
                    alert('Please select at least one letter');
                    return;
                }

                const checkboxes = document.querySelectorAll('input[name="release_ids"]');
                checkboxes.forEach(function(checkbox) {
                    const row = checkbox.closest('tr');
                    const artistCell = row.querySelector('td:nth-child(3)'); // Artist is in 3rd column
                    const artistName = artistCell.textContent.trim();
                    
                    // Check if artist starts with any of the selected letters
                    const artistLetter = getArtistFirstLetterCategory(artistName);
                    const shouldDeselect = selectedLetters.has(artistLetter);
                    
                    if (shouldDeselect) {
                        checkbox.checked = false;
                    }
                });
            });
        });
    </script>
{% endblock %}